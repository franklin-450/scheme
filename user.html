<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scheme Hub - Buy & Download</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>body {
  background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
  color: #f1f1f1;
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background-attachment: fixed;
  background-size: cover;
  background-repeat: no-repeat;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.card {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 1rem;
  backdrop-filter: blur(10px);
  color: #e0f7fa;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  min-height: 280px;
}

.card:hover {
  transform: translateY(-6px);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
}

.card h5 {
  color: #90caf9;
}

.card p {
  font-size: 0.95rem;
  color: #cfd8dc;
}

.btn-pay {
  background-color: #00c853;
  color: white;
  font-weight: 600;
  transition: background-color 0.3s ease;
}

.btn-pay:hover {
  background-color: #00e676;
}

.btn-download {
  background-color: #2962ff;
  color: white;
  font-weight: 600;
  transition: background-color 0.3s ease;
}

.btn-download:hover {
  background-color: #448aff;
}

.btn:disabled {
  background-color: #999 !important;
  cursor: not-allowed;
}

input.form-control {
  background-color: #263238;
  border: 1px solid #455a64;
  color: #ffffff;
  border-radius: 0.5rem;
}

input.form-control::placeholder {
  color: #b0bec5;
}

    .hero-overlay {
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(6px);
  padding: 4rem 2rem;
  text-align: center;
  border-radius: 20px;
  margin: 3rem auto 2rem;
  max-width: 800px;
}

.hero-overlay h1,
.hero-overlay p {
  text-align: center;
  color: #ffffff;
}

.hero-overlay h1 {
  font-size: 2.5rem;
  font-weight: 700;
  margin-bottom: 1rem;
}

.hero-overlay p {
  font-size: 1.2rem;
  font-weight: 400;
  margin-bottom: 0;
}


  footer {
    text-align: center;
    font-size: 0.9rem;
    color: #ccc;
    padding: 2rem 1rem;
    margin-top: 2rem;
  }
</style>
</head>

<body>
    <div class="background-slide" id="background-slide"></div>

    <div class="hero-overlay text-white">
        <h1 data-aos="fade-down">üìö Learning Resource Hub</h1>
        <p data-aos="fade-up">Buy your package before downloading ‚Äì powered by Fintech Super Companies</p>

    </div>

    <div class="row justify-content-center mb-4">
        <div class="col-md-6">
            <input type="text" id="searchBox" class="form-control form-control-lg"
                placeholder="üîç Search by title, subject or class..." oninput="filterSchemes()">
        </div>
    </div>

    <div class="container">
        <h2 class="text-center mb-4" data-aos="fade-up">üõç Available Schemes</h2>
        <div class="row" id="scheme-list"></div>

        <h2 class="text-center my-5" data-aos="fade-up">üìù Revision Papers</h2>
        <div class="row" id="revision-list"></div>
    </div>

    <footer>
        Powered by <strong>Fintech & Edutech</strong> ‚Äî A Franklin's Product
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    <script>
        AOS.init();

        const unsplashImages = [
            'https://source.unsplash.com/featured/?school',
            'https://source.unsplash.com/featured/?education',
            'https://source.unsplash.com/featured/?students',
            'https://source.unsplash.com/featured/?classroom'
        ];

        let imgIndex = 0;
        const backgroundDiv = document.getElementById('background-slide');

        function preloadImages(urls, callback) {
            let loaded = 0;
            urls.forEach(url => {
                const img = new Image();
                img.src = url;
                img.onload = () => {
                    if (++loaded === urls.length) callback();
                };
                img.onerror = () => {
                    if (++loaded === urls.length) callback();
                };
            });
        }

        preloadImages(unsplashImages, () => {
            backgroundDiv.style.backgroundImage = `url('${unsplashImages[imgIndex]}')`;
            setInterval(() => {
                imgIndex = (imgIndex + 1) % unsplashImages.length;
                backgroundDiv.style.backgroundImage = `url('${unsplashImages[imgIndex]}')`;
            }, 5000);
        });

async function loadSchemes() {
  try {
    const res = await fetch("https://server-1-bmux.onrender.com/api/files");
    const files = await res.json();
    const schemeList = document.getElementById("scheme-list");
    const revisionList = document.getElementById("revision-list");

    schemeList.innerHTML = '';
    revisionList.innerHTML = '';

    files.forEach(file => {
      const card = document.createElement("div");
      card.className = "col-md-4 mb-4";

card.innerHTML = `
  <div class="card shadow-lg border-0 p-3 h-100 d-flex flex-column justify-content-between bg-gradient" style="background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(8px);">
    <div>
      <h5 class="fw-bold text-white"><i class="bi bi-journal-richtext me-2"></i>${file.title}</h5>
      <p class="mb-1 text-light"><i class="bi bi-book-half me-2 text-warning"></i><strong>Subject:</strong> ${file.subject}</p>
      <p class="mb-1 text-light"><i class="bi bi-mortarboard me-2 text-info"></i><strong>Class:</strong> ${file.class}</p>
      <p class="mb-1 text-light"><i class="bi bi-cash-coin me-2 text-success"></i><strong>Price:</strong> <span class="text-warning">KES ${file.price}</span></p>
    </div>
    <div class="d-grid gap-2 mt-3">
      <button class="btn btn-outline-warning btn-lg rounded-pill fw-semibold" onclick="payFor('${file.filename}', this)">
        <i class="bi bi-phone-fill"></i> Pay via M-Pesa
      </button>
      <button class="btn btn-outline-light btn-sm rounded-pill" disabled>
        <i class="bi bi-lock-fill"></i> Download locked
      </button>
    </div>
  </div>`;


      if (file.type && file.type.toLowerCase() === "revision") {
        revisionList.appendChild(card);
      } else {
        schemeList.appendChild(card);
      }
    });
  } catch (err) {
    Swal.fire("Error", "Failed to load schemes", "error");
  }
}


        function loadMyDownloads() {
            const saved = JSON.parse(localStorage.getItem('downloads') || '[]');
            if (!saved.length) return;

            const section = document.createElement('div');
            section.innerHTML = `<h3 class="mt-5 text-center">üìú My Downloads</h3><div class="row mt-3" id="my-downloads"></div>`;
            document.querySelector('.container').appendChild(section);

            const list = document.getElementById('my-downloads');
            saved.forEach(item => {
                const card = document.createElement('div');
                card.className = 'col-md-4 mb-4';
                card.innerHTML = `
        <div class="card p-3">
          <h5>${item.filename}</h5>
          <a class="btn btn-download" href="https://server-1-bmux.onrender.com/files/${item.filename}?token=${item.token}" download>Download Again</a>
        </div>
      `;
                list.appendChild(card);
            });
        }

        function filterSchemes() {
            const input = document.getElementById('searchBox').value.toLowerCase();
            const cards = document.querySelectorAll('#scheme-list .card, #revision-list .card');

            cards.forEach(card => {
                const text = card.innerText.toLowerCase();
                card.parentElement.style.display = text.includes(input) ? 'block' : 'none';
            });
        }

        function payFor(filename, btn) {
            Swal.fire({
                title: 'Enter Phone Number',
                input: 'text',
                inputPlaceholder: '07XXXXXXXX',
                confirmButtonText: 'Pay Now',
                showCancelButton: true,
                preConfirm: (value) => {
                    if (!/^07\d{8}$/.test(value)) {
                        Swal.showValidationMessage('Invalid Safaricom number!');
                    }
                }
            }).then(result => {
                if (result.isConfirmed) {
                    Swal.fire({ title: 'Sending STK Push...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

                    fetch('https://server-1-bmux.onrender.com/api/pay', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ phone: result.value, filename })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                Swal.close();
                                Swal.fire('Success', 'Payment confirmed. Download unlocked.', 'success');

                                const downloadBtn = btn.nextElementSibling;
                                downloadBtn.disabled = false;
                                downloadBtn.innerHTML = `<a class="text-white text-decoration-none" href="https://server-1-bmux.onrender.com/api/files/${filename}?token=${data.token}" download>Download</a>`;

                                const downloads = JSON.parse(localStorage.getItem('downloads') || '[]');
                                downloads.push({ filename, token: data.token });
                                localStorage.setItem('downloads', JSON.stringify(downloads));

                                loadMyDownloads();
                            } else {
                                Swal.fire('Failed', 'Payment was not successful.', 'error');
                            }
                        });
                }
            });
        }

        loadSchemes();
        loadMyDownloads();
    </script>
</body>

</html>
